---
title: "The Dangers of Including Endogenous Time-Varying Covariates in Clustered Longitudinal Data Analysis"
author: 
  - name: "By: Ward B. Eiling, Supervisors: Ellen Hamaker & Jeroen Mulder"
    orcid: 0009-0007-8114-9497
institute: "Utrecht University"
format: 
  # revealjs:
  #   theme: white
  #   # transition: slide
  #   controls: true
  #   progress: true
  #   slideNumber: true
  #   history: true
  #   center: true
  #   # width: 1920
  #   # height: 1080
  #   embed-resources: true
  #   aspectratio: 169
    # navigation: horizontal
    # slideNumber: c/t
    # history: true
    # center: true
    # width: 1920
    # height: 1080
    # margin: 0.1
    # minScale: 0.5
    # maxScale: 1.0
  beamer:
    aspectratio: 169
    navigation: horizontal
    incremental: true 
    keep_tex: true
  #   # theme: AnnArbor
  #   # colortheme: lily
bibliography: references.bib
---

## Once upon a time...

<!-- > "random effects models were designed for settings where the covariates are considered fixed, and inferential challenges arise when one tries to apply the standard random effects model if there are endogenous time-varying covariates." [@qian2020] -->

> "To our surprise, even without time-varying confounding (e.g., when the randomization probability is constant in an MRT), the inclusion of endogenous covariates in random effects models can cause bias in assessment of the treatment effects." [@qian2020]

> "when using generalized estimating equations (GEE) with endogenous covariates, one should use working independence correlation structure to avoid biased estimates"[@pepe1994; @qian2020]

> "the issue ... is important for all longitudinal data analysis methods" [@diggle2002]

So we should all be using GEE with working independence?

## The Project

Aims:

1.  Restate the issue in a psychological context
<!-- for instance, are we able to understand this bias in the treatment effect in terms of DAGs? -->
2.  Provide practical recommendations
<!-- for instance, in what situation is the bias of MLM worrisome and when is it negligible?  -->

## Endogenous Time-varying Covariates: What Are They?

```{r}
#| label: fig-pathdiagram.section2.2
#| engine: 'tikz'
#| cache: true
#| echo: false
#| fig-cap: "Path Diagram of Model Without Treatment"

\begin{tikzpicture}
  % Nodes
  \node[draw] (X1) at (1.5, 1.5) {$X_1$};
  \node[draw] (X2) at (6.0, 1.5) {$X_2$};
  \node[draw] (Y2) at (6.0, 3.5) {$Y_2$};
  \node[draw] (Y3) at (10.0, 3.5) {$Y_3$};
  \node[draw, circle, fill=gray!20] (b0) at (8.0, 5.5) {$b_{0i}$};
  \node[draw, circle, fill=gray!20] (eY2) at (7.5, 3.5) {$\epsilon_{i2}$};
  \node[draw, circle, fill=gray!20] (eY3) at (11.5, 3.5) {$\epsilon_{i3}$};

  % Edges with labels
  \draw[->] (X1) -- (Y2) node[midway, below right] {$\beta_{1}$};
  \draw[->] (X2) -- (Y3) node[midway, below right] {$\beta_{1}$};
  \draw[->] (Y2) -- (X2) node[midway, left] {$=$};
  \draw[->] (b0) -- (Y2) node[midway, left] {$+$};
  \draw[->] (b0) -- (Y3) node[midway, left] {$+$};
  \draw[->] (eY2) -- (Y2) ;
  \draw[->] (eY3) -- (Y3) ;

  % Double-headed arrows for residual variances
  \draw[<->, out=120, in=60, looseness=1.5] (eY2) to node[above] {$\sigma_{\epsilon}^2$} (eY2);
  \draw[<->, out=120, in=60, looseness=1.5] (eY3) to node[above] {$\sigma_{\epsilon}^2$} (eY3);
  \draw[<->, out=120, in=60, looseness=1.5] (X1) to node[above] {$\sigma_{X_1}^2$} (X1);
  \draw[<->, out=120, in=60, looseness=1.5] (b0) to node[above] {$\sigma_{b_0}^2$} (b0);

\end{tikzpicture}
```

## Endogenous Time-varying Covariates: What Are They?

```{r}
#| label: fig-pathdiagram.section2.2_2
#| engine: 'tikz'
#| cache: true
#| echo: false
#| fig-cap: "Path Diagram of Model Without Treatment"

\begin{tikzpicture}
  % Nodes
  \node[draw] (X1) at (1.5, 1.5) {$X_1$};
  \node[draw] (X2) at (6.0, 1.5) {$X_2$};
  \node[draw] (Y2) at (6.0, 3.5) {$Y_2$};
  \node[draw] (Y3) at (10.0, 3.5) {$Y_3$};
  \node[draw, circle, fill=gray!20] (b0) at (8.0, 5.5) {$b_{0i}$};
  \node[draw, circle, fill=gray!20] (eY2) at (7.5, 3.5) {$\epsilon_{i2}$};
  \node[draw, circle, fill=gray!20] (eY3) at (11.5, 3.5) {$\epsilon_{i3}$};

  % Edges with labels
  \draw[->, blue] (X1) -- (Y2) node[midway, below right] {$\beta_{1}$};
  \draw[->, blue] (X2) -- (Y3) node[midway, below right] {$\beta_{1}$};
  \draw[->] (Y2) -- (X2) node[midway, left] {$=$};
  \draw[->] (b0) -- (Y2) node[midway, left] {$+$};
  \draw[->] (b0) -- (Y3) node[midway, left] {$+$};
  \draw[->] (eY2) -- (Y2) ;
  \draw[->] (eY3) -- (Y3) ;

  % Double-headed arrows for residual variances
  \draw[<->, out=120, in=60, looseness=1.5] (eY2) to node[above] {$\sigma_{\epsilon}^2$} (eY2);
  \draw[<->, out=120, in=60, looseness=1.5] (eY3) to node[above] {$\sigma_{\epsilon}^2$} (eY3);
  \draw[<->, out=120, in=60, looseness=1.5] (X1) to node[above] {$\sigma_{X_1}^2$} (X1);
  \draw[<->, out=120, in=60, looseness=1.5] (b0) to node[above] {$\sigma_{b_0}^2$} (b0);

\end{tikzpicture}
```

<!-- mention that focus is on estimation of beta_1 -->

<!-- Let us take the following data generating model. Some of you may recognize this to essentially be a lag 1 autoregressive model, where, for instance, we measure anxiety at three timepoints and fit a model to its lagged version, while controlling for the baseline anxiety and considering stable individual differences. -->

<!-- In this path diagram, if we follow the red line, we can clearly see that Z is an endogenous covariate, as it is determined by the outcome Y and thus also by indirectly by the random intercept u_0i -->

<!-- Thus, when covariates are determined by the outcome, the covariate is also determined by the random effects, with the result that the conditional relationship no longer reduces to the marginal relationship.  -->
<!-- When we now fit an MLM, we will only be able to interpret the fixed effects according to the conditional interpretation. -->

## Expanding to a Generative Model with Treatment

```{r}
#| label: fig-GM1_path
#| engine: 'tikz'
#| echo: false
#| cache: true
#| fig-cap: "Path diagram for Generative Model 1"
#| eval: true

\begin{tikzpicture}
  % Nodes for observed variables (squares)
  \node[draw, rectangle] (X1) at (0, -2) {$X_{1i}$};
  \node (X1var) at (0, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A1) at (0, 2) {$A_{1i}$};
  \node[draw, rectangle] (A1X1) at (0.3, 0) {$A_{1i}\cdot X_{1i}$};
  \node[draw, rectangle] (Y2) at (3, 0) {$Y_{2i}$}; % Increased x-coordinate
  \node (Y2var) at (4, 0) {$\sigma^2_{\epsilon}$};
  \node[draw, rectangle] (X2) at (3, -2) {$X_{2i}$}; % Increased x-coordinate
  \node (X2var) at (3, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A2) at (3, 2) {$A_{2i}$}; % Increased x-coordinate
  \node[draw, rectangle] (Y3) at (8, 0) {$Y_{3i}$}; % Increased x-coordinate
  \node (Y3var) at (9, 0) {$\sigma^2_{\epsilon}$};
  \node[draw, rectangle] (X3) at (8, -2) {$X_{3i}$}; % Increased x-coordinate
  \node (X3var) at (8, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A2X2) at (5.3, 0) {$A_{2i}\cdot X_{2i}$}; % Increased x-coordinate

  % Nodes for latent variables (circles)
  \node[draw, circle] (b0) at (6, 4) {$b_{i0}$}; % Increased x-coordinate
  \node[draw, circle] (b2) at (3, 4) {$b_{i2}$}; % Adjusted to align with middle row

  % Arrows with path coefficients
  \draw [->] (b0) -- node[right] {$+$} (Y2);
  \draw [->] (b0) -- node[right] {$+$} (Y3);
  \draw [->, blue] (A2) edge node[above] {$\beta_0$} (Y3);
  \draw [->] (X2) edge node[below] {$\alpha_1$} (Y3);
  \draw [->] (Y2) edge node[left] {$=$} (X2);
  \draw [->, blue] (A1) edge node[left] {$\beta_0$} (Y2);
  \draw [->] (X1) edge node[below] {$\alpha_1$} (Y2);
  \draw [->] (Y3) edge node[right] {$=$} (X3);
  \draw [->] (A1X1) edge node[above] {$\beta_1$} (Y2);
  \draw [->] (A2X2) edge node[above] {$\beta_1$} (Y3);
  \draw [->] (X1var) edge (X1);
  \draw [->] (X2var) edge (X2);
  \draw [->] (X3var) edge (X3);
  \draw [->] (Y2var) edge (Y2);
  \draw [->] (Y3var) edge (Y3);

  % Curved arrows for variances
  \draw [<->, out=45, in=135, looseness=2] (b0) to node[above] {$\sigma^2_{b0}$} (b0);
  \draw [<->, out=45, in=135, looseness=2] (b2) to node[above] {$\sigma^2_{b2}$} (b2);

  % Additional paths for A and X interaction effects
  \draw[->, dashed] (b2) -- (1.5,1); % Adjusted x-coordinates
  \draw[->, dashed] (b2) -- (5,1.2); % Adjusted x-coordinates

\end{tikzpicture}
```

## Generative Model 3

```{r}
#| label: fig-GM3_path
#| engine: 'tikz'
#| echo: false
#| cache: true
#| fig-cap: "Path diagram for Generative Model 3"
#| eval: true

\begin{tikzpicture}
  % Nodes for observed variables (squares)
  \node[draw, rectangle] (X1) at (0, -2) {$X_{1i}$};
  \node (X1var) at (0, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A1) at (0, 2) {$A_{1i}$};
  \node[draw, rectangle] (A1X1) at (0.3, 0) {$A_{1i}\cdot X_{1i}$};
  \node[draw, rectangle] (Y2) at (3, 0) {$Y_{2i}$}; % Increased x-coordinate
  \node (Y2var) at (4, 0) {$\sigma^2_{\epsilon}$};
  \node[draw, rectangle] (X2) at (3, -2) {$X_{2i}$}; % Increased x-coordinate
  \node (X2var) at (3, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A2) at (3, 2) {$A_{2i}$}; % Increased x-coordinate
  \node[draw, rectangle] (Y3) at (8, 0) {$Y_{3i}$}; % Increased x-coordinate
  \node (Y3var) at (9, 0) {$\sigma^2_{\epsilon}$};
  \node[draw, rectangle] (X3) at (8, -2) {$X_{3i}$}; % Increased x-coordinate
  \node (X3var) at (8, -3) {$\sigma^2_{X}$};
  \node[draw, rectangle] (A2X2) at (5.3, 0) {$A_{2i}\cdot X_{2i}$}; % Increased x-coordinate

  % Nodes for latent variables (circles)
  \node[draw, circle] (b0) at (6, 4) {$b_{i0}$}; % Increased x-coordinate
  \node[draw, circle] (b2) at (3, 4) {$b_{i2}$}; % Adjusted to align with middle row

  % Arrows with path coefficients
  \draw [->] (b0) -- node[right] {$+$} (Y2);
  \draw [->] (b0) -- node[right] {$+$} (Y3);
  \draw [->, blue] (A2) edge node[above] {$\beta_0$} (Y3);
  \draw [->] (X2) edge node[below] {$\alpha_1$} (Y3);
  \draw [->] (Y2) edge node[left] {$=$} (X2);
  \draw [->, blue] (A1) edge node[left] {$\beta_0$} (Y2);
  \draw [->] (X1) edge node[below] {$\alpha_1$} (Y2);
  \draw [->] (Y3) edge node[right] {$=$} (X3);
  \draw [->] (A1X1) edge node[above] {$\beta_1$} (Y2);
  \draw [->] (A2X2) edge node[above] {$\beta_1$} (Y3);
  \draw [->] (X1var) edge (X1);
  \draw [->] (X2var) edge (X2);
  \draw [->] (X3var) edge (X3);
  \draw [->] (Y2var) edge (Y2);
  \draw [->] (Y3var) edge (Y3);
  \draw [->, red] (b0) edge (X1);
  \draw [->, red] (b0) edge (X2);
  \draw [->, red] (b0) edge (X3);

  % Curved arrows for variances
  \draw [<->, out=45, in=135, looseness=2] (b0) to node[above] {$\sigma^2_{b0}$} (b0);
  \draw [<->, out=45, in=135, looseness=2] (b2) to node[above] {$\sigma^2_{b2}$} (b2);

  % Additional paths for A and X interaction effects
  \draw[->, dashed] (b2) -- (1.5,1); % Adjusted x-coordinates
  \draw[->, dashed] (b2) -- (5,1.2); % Adjusted x-coordinates

\end{tikzpicture}
```

## Variations on GM3


## DAGs are the Same?

- Pearl’s backdoor criterion and interaction effects?

<!-- Alternatively, if too much time, put this in the discussion section -->

## Simulation Results


## Discussion: Takeaways and Moving Forward

-   Marginal relationship primary interest?

<!-- (e.g., screening)  -->

    -   GEE with independence
-   In practice, we don’t know the DGM

<!-- -   Does it include endogenous covariates? -->
<!-- -   Does conditional independence hold? -->
<!-- Generative Model 2 in qian was simulated with very implausible data (high and low values of X and Y). Therefore GEE estimates were inflated. We should be mindful that generative models should be plausible. -->

    -   Theory-based decisions
-   Next steps
    -   What makes bias increase?

<!-- -   of random intercept/slope and interaction effects? -->


## References

::: {#refs}
:::

## Appendix
