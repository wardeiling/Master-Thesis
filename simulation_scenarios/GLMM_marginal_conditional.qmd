---
title: "generalized mixed linear model: marginal versus conditional effects"
author: "Ward B. Eiling"
format: html
editor: visual
bibliography: GLMM_references.bib
---

## Generalized Mixed Linear Model with Non-linear Logit Function

In this document, we will reproduce the figure made by Dimitri Rizopoulos in de course "CE08", where the generalized mixed linear model (GLMM) with a non-linear logit function results in a discrepancy between the marginal and conditional relationships (see also @Zeger1988 for the similar and original treatment). Let us consider the following GLMM

$$
log \frac{\pi_{it}}{1-\pi_{it}} = \alpha_0 + \alpha_1 X_{it} + b_{0i} + \epsilon_{it} \quad b_{0i} \sim \mathcal{N}(0,\sigma_{b0}^2)
$$

Where $\pi_{it} = Pr(Y_{it} = 1)$ the probability of a positive response for subject $i$ at time $t$, $Y_{it}$ is the binary response variable, $X_{it}$ is the continuous covariate, $A_{it}$ is the binary treatment indicator, and $b_{0i}$ is the random intercept. The fixed effects are $\alpha_0$ and $\alpha_1$ for the intercept and the continuous covariate. The random intercept $b_{0i}$ is assumed to be normally distributed with mean zero and variance $\sigma_{b0}^2$.

We specify the following parameter values

-   $\alpha_0 = 0$
-   $\alpha_1 = 0.9$
-   $\sigma_{b0}^2 = 4$

For simplicity, this model does not include a treatment effect $A_{it}$ nor exogenous noise $\epsilon_{it}$. Now we will simulate data from this model and directly infer the relationships between the continuous covariate $X_{it}$ and the probability of a positive response $\pi_{it}$.

```{r}
#| label: fig-marginal-vs-conditional
#| fig.width: 10
#| fig.height: 8

set.seed(123) # For reproducibility

# Parameters
alpha_0 <- 0 # for simplicity
alpha_1 <- 0.9
sigma_b0 <- sqrt(4)

n_individuals <- 20 # Number of individuals to plot
X_grid <- seq(-5, 5, length.out = 10000) # Values for X_it

# Generate random intercepts for individuals
b0 <- rnorm(n_individuals, mean = 0, sd = sigma_b0)

# Conditional-level logit and probability: the mean individual (b0 = 0)
logit_conditional <- alpha_0 + alpha_1 * X_grid + 0
pi_conditional <- 1 / (1 + exp(-logit_conditional))

# Individual-specific logits and probabilities
logit_individuals <- sapply(b0, function(b) alpha_0 + alpha_1 * X_grid + b)
pi_individuals <- 1 / (1 + exp(-logit_individuals))

# Population-level logit and probability: average probabilities across individuals
pi_population <- rowMeans(pi_individuals)

# save the upcoming plot
png("figure/fig-marginal-vs-conditional.png", width = 1200, height = 1000, res = 150)

# Plot the conditional-level curve
plot(X_grid, pi_conditional, type = "l", lwd = 4, col = "black",
     ylim = c(0, 1), xlim = c(-5, 5), xlab = expression(X[it]), ylab = expression(pi),
     main = "Population, Conditional and Individual Logit Curves")

# Add individual curves (grey lines)
for (i in 1:n_individuals) {
  lines(X_grid, pi_individuals[, i], col = "grey", lwd = 1)
}

# add the population-level curve (red line)
lines(X_grid, pi_population, col = "red", lwd = 4)

# Add a legend
legend("topleft", legend = c("conditional", "population", "individuals"),
       col = c("black", "red",  "grey"), lty = c(1, 1, 1), lwd = c(4, 4, 1))

dev.off()
```

When we estimate the GLMM with the log link function, we obtain the conditional-on-the-random effects interpretation of fixed-effects regression coefficients (i.e., the effects of covariates on changes in an individualâ€™s transformed mean response). This is directly opposed by marginal models such as GEE, where "population averages are the targets of inference" (Rizopoulos, CE08, p. 331)

## Mixed Linear Model: Generalized Linear Mixed Model with Identity Link Function

```{r}

```
