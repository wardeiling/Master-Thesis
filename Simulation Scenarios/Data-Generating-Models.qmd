---
title: "Estimation Methods"
author: "Ward B. Eiling"
format: html
execute:
  message: false
  warning: false
embed-resources: false
---

## Introduction

In this document, we will compare estimation methods in the context of clustered data (measurements within invididuals): generalized estimating equations (GEE) and mixed linear models (MLM).

Let's first install and load necessary packages

```{r}
# Load packages
library(dagitty)
library(tidyverse)
library(ggdag)
library(purrr)
library(qgraph)
library(pcalg)
library(sjPlot)
library(lme4)
library(geex)
library(gee)
library(MASS)
library(jtools)
```

For all examples, we will use the same basic DAG, where we are estimating the effect of $X_t$ (sleep-problems) on $Y_t$ (anxiety). This implies that we are investigating the effect of sleep problems on anxiety within the same timepoint (we could also use a lagged effect, but we will keep it simple for now).

```{r}
#| label: DAG
#| cache: true
#| fig.cap: "DAG for the data generating models"

dag <- dagitty('dag {
  "X_t" -> "Y_t"
}')

plot(dag)
```

## Scenario 1: SCM with random intercept and a time-varying $X$ *without* between-person differences in $\bar{X}_i$ (a mean of 0 for everyone)

For the first DGM, using the multilevel notation (Raudenbusch and Bryk, 2002), we can specify the within person equation

$$Y_{it} = \beta_{0i} + \beta_1 X_{it} + e_{it} \quad \text{where} \quad e_{it} \sim \mathcal{N}(0, \sigma^2_{e}), \text{iid}$$

and between person equation

$$\beta_{0i} = \gamma_{00} + u_{0i} \quad \text{where} \quad u_{0i} \sim \mathcal{N}(0, \sigma^2_{u0})$$

By plugging the between person equation into the within-person equation we get the combined expression

$$Y_{it} = \gamma_{00} + u_{0i} + \beta_1 X_{it} + e_{it}$$

where (1) $\gamma_{00}$ is the overall intercept, (2) $\beta_1$ is the fixed slope and (3) $u_{0i}$ is the random intercept for individual $i$.

Given that we want no between person differences in the mean level of $X$ over time and for it to be centered around 0 (i.e., $\bar{\mu}_{i}= 0$), we may simulate $X_{it}$ as such

$$X_{it} \sim \mathcal{N}(0, \sigma^2_{X})$$

Now we may, for instance, give the parameters arbitrary values (note that I define the standarddeviations instead of the variances)

-   $\gamma_{00} = 2$
-   $\beta_{1}= 0.6$
-   $\sigma_{u0}= 1$
-   $\sigma_{e}= 0.1$
-   $\sigma_{X}= 1$

Let us now simulate data according to data generating model 1

```{r}
# Specify parameters
set.seed(123)  # For reproducibility
n_i <- 10000  # Number of individuals
n_t <- 10  # Number of timepoints
n_obs <- n_i * n_t  # Total number of observations

gamma_00 <- 2
beta_1 <- 0.6
sigma_u0 <- 1
sigma_e <- 0.1 # this may be unrealistic, but we want to see the effect of the estimation method
sigma_X <- 1

# Simulate data
X = rnorm(n_obs, 0, sigma_X)
e = rnorm(n_obs, 0, sigma_e)
u_0i = rnorm(n_i, 0, sigma_u0)


scenario1.data <- tibble(
  id = rep(1:n_i, each = n_t),
  time = rep(1:n_t, times = n_i),
  X = X,
  e = e,
  u_0i = rep(u_0i, each = n_t),
  Y = gamma_00 + u_0i + beta_1 * X + e)

head(scenario1.data)
```

Let's plot the first 10 individuals with different colors for each participant and separate regression lines for each participant

```{r}
scenario1.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) +
  theme_minimal()
```

Let's now do the same but with the true regression lines for each individual

```{r}
head(u_0i, 5)

scenario1.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) + # overall regression line
  geom_abline(intercept = gamma_00 + u_0i[1], slope = beta_1, color = "red", size = 1) + # for id = 1
  geom_abline(intercept = gamma_00 + u_0i[2], slope = beta_1, color = "orange", size = 1) + # for id = 2
  geom_abline(intercept = gamma_00 + u_0i[3], slope = beta_1, color = "green", size = 1) + # for id = 3
  geom_abline(intercept = gamma_00 + u_0i[4], slope = beta_1, color = "blue", size = 1) + # for id = 4
  geom_abline(intercept = gamma_00 + u_0i[5], slope = beta_1, color = "purple", size = 1) + # for id = 5
  theme_minimal()
```

Let's estimate the effect of $X$ on $Y$ using MLM

```{r}
scenario1.MLM_reml <- lmer(Y ~ 1 + X + (1 | id), data = scenario1.data, REML = TRUE)
scenario1.MLM_mle <- lmer(Y ~ 1 + X + (1 | id), data = scenario1.data, REML = FALSE)

# as.numeric(VarCorr(scenario1.MLM_mle)$id[1]) # aligns with specification of sigma_u0
```

Let's now estimate the effect of $X$ on $Y$ using GEE

```{r}
# displays initial regression estimate of GLM
scenario1.GEE_exch <- gee(Y ~ X, data = scenario1.data, id = id, family = gaussian(), corstr = "exchangeable")
scenario1.GEE_ind <- gee(Y ~ X, data = scenario1.data, id = id, family = gaussian(), corstr = "independence")
scenario1.GEE_ar <- gee(Y ~ X, data = scenario1.data, id = id, family = gaussian(), corstr = "AR-M")
scenario1.GEE_uns <- gee(Y ~ X, data = scenario1.data, id = id, family = gaussian(), corstr = "unstructured") # with n = 100  convergence was not achieved
# scenario1.GEE_fixed <- gee(Y ~ X, data = scenario1.data, id = id, family = gaussian(), corstr = "fixed") # takes very long to converge
```

Let's compare the point estimates

```{r}
# Extracting the coefficients
scenario1.coefs <- data.frame(
  row.names = c("Intercept", "X"),
  coef_MLM_reml = fixef(scenario1.MLM_reml),
  coef_MLM_mle = fixef(scenario1.MLM_mle),
  coef_GEE_exch = coef(scenario1.GEE_exch),
  coef_GEE_ind = coef(scenario1.GEE_ind),
  coef_GEE_ar = coef(scenario1.GEE_ar),
  coef_GEE_uns = coef(scenario1.GEE_uns))

# Create nice table
knitr::kable(scenario1.coefs, digits = 3)
```

The point estimates are essentially identical with $n = 10.000$. However, efficiency/convergence rates may differ across working correlation structures, as unstructured did not convergence with $n = 100$.

De interpretatie for the fixed effects is als volgt:

-   intercept: de gemiddelde angst ($Y$) over alle proefpersonen genomen $\approx 2$, wanneer slaapproblemen ($X$) 0 zijn, waarbij variatie tussen proefpersonen genegeerd wordt. In technische termen, we nemen gelijke waarden aan voor de random effecten.

-   slope: voor een eenheid verandering in slaapproblemen ($X$), wordt verwacht dat angst ($Y$) verandert met $\approx 0.6$, waarbij variatie tussen proefpersonen genegeerd wordt. In technische termen, we nemen gelijke waarden aan voor de random effecten.

## Scenario 2: SCM met een random intercept, time-varying $X$ en *met* between-person verschillen in $\bar{\mu}_{i}$ (de ene proefpersoon heeft een hogere gemiddelde dan een ander over de tijdspunten)

For the second DGM, using the multilevel notation (Raudenbusch and Bryk, 2002), we can specify the within person equation with the predictor within-person centered

$$Y_{it} = \beta_{0i} + \beta_1 (X_{it} - \bar{\mu}_{i}) + e_{it} \quad \text{where} \quad e_{it} \sim \mathcal{N}(0, \sigma^2_{e}), \text{iid}$$

Note that by using the within-person centered predictor $X_{it} - \bar{\mu}_{i}$, we disentangle the within-person and between-person slopes, whereas the use of the non-centered predictor $X_{it}$ would have yielded a weighted sum of the estimated slopes at both levels.

and between person equation

$$\beta_{0i} = \gamma_{00} + u_{0i} \quad \text{where} \quad u_{0i} \sim \mathcal{N}(0, \sigma^2_{u0})$$

By plugging the between person equation into the within-person equation we get the combined expression

$$Y_{it} = \gamma_{00} + u_{0i} + \beta_1 (X_{it} - \bar{\mu}_{i}) + e_{it}$$

where (1) $\gamma_{00}$ is the overall intercept, (2) $\beta_1$ is the fixed slope and (3) $u_{0i}$ is the random intercept for individual $i$.

Given that we want between person differences in the mean level of $X$ over time, we may simulate $X_{it}$ as such

$$X_{it} = \bar{\mu}_{i} + e_{X, it} \quad \text{where} \quad e_{X, it} \sim \mathcal{N}(0, \sigma^2_{X})$$

where

$$\bar{\mu}_{i} \sim \mathcal{N}(\mu_{\bar{\mu}}, \sigma^2_{\bar{\mu}})$$

Now we may, for instance, give the parameters arbitrary values In addition to the arbitrary values we chose for scenario 1 (note that I define the standarddeviations instead of the variances)

-   $\gamma_{00} = 2$
-   $\beta_{1}= 0.6$
-   $\sigma_{u0}= 1$
-   $\sigma_{e}= 0.1$
-   $\sigma_{X}= 1$

We now have to also define

-   $\mu_{\bar{\mu}} = 3$
-   $\sigma_{\bar{\mu}} = 1$

Let us now simulate data according to data generating model 2

```{r}
# Specify parameters
set.seed(123)  # For reproducibility
n_i <- 1000  # Number of individuals
n_t <- 10  # Number of timepoints
n_obs <- n_i * n_t  # Total number of observations

gamma_00 <- 2
beta_1 <- 0.6 # represents the within-person slope
sigma_u0 <- 1
sigma_e <- 0.1 # this may be unrealistic, but we want to see the effect of the estimation method
sigma_X <- 1

mu_mu_bar <- 3
sigma_mu_bar <- 1

# Simulate data
mu_bar_i = rnorm(n_i, mu_mu_bar, sigma_mu_bar)
u_0i = rnorm(n_i, 0, sigma_u0)

# Create a data frame to store the simulated data
scenario2.data <- data.frame()

for (i in 1:n_i) {
  for (t in 1:n_t) {
    
    X_it <- mu_bar_i[i] + rnorm(1, mean = 0, sd = sigma_X)
    
    e_it <- rnorm(1, mean = 0, sd = sigma_e)
    
    Y_it <- gamma_00 + u_0i[i] + beta_1 * (X_it - mu_bar_i[i]) + e_it
    
    # Store the values in the data frame
    scenario2.data <- rbind(scenario2.data, data.frame(id = i, time = t, X = X_it, Y = Y_it, mu_bar = mu_bar_i[i]))
  }
}

head(scenario2.data)
```

first, we have to estimate $\bar{\mu}_i$. One way to do this is by computing the sample mean $\bar{X}_i$ for every individual. Now we can create the centered within clusters variable $X_{it} - \bar{X}_{i}$

```{r}
scenario2.data <- scenario2.data %>%
  group_by(id) %>%
  mutate(X_bar = mean(X)) 

scenario2.data$X_cwc <- scenario2.data$X - scenario2.data$X_bar
scenario2.data$X_cwc_population <- scenario2.data$X - scenario2.data$mu_bar

head(scenario2.data)
```

Let's plot the first 10 individuals with different colors for each participant and separate regression lines for each participant

```{r}
scenario2.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) +
  theme_minimal()
```

Let's now do the same but with the true regression lines for each individual

```{r}
head(u_0i, 5)
head(mu_bar_i, 5)

# True values of the mean of X
scenario2.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc_population, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) + # overall regression line
  geom_abline(intercept = gamma_00 + u_0i[1], slope = beta_1, color = "red", size = 1) + # for id = 1
  geom_abline(intercept = gamma_00 + u_0i[2], slope = beta_1, color = "orange", size = 1) + # for id = 2
  geom_abline(intercept = gamma_00 + u_0i[3], slope = beta_1, color = "green", size = 1) + # for id = 3
  geom_abline(intercept = gamma_00 + u_0i[4], slope = beta_1, color = "blue", size = 1) + # for id = 4
  geom_abline(intercept = gamma_00 + u_0i[5], slope = beta_1, color = "purple", size = 1) + # for id = 5
  theme_minimal()

# Sample values of the mean of X
scenario2.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) + # overall regression line
  geom_abline(intercept = gamma_00 + u_0i[1], slope = beta_1, color = "red", size = 1) + # for id = 1
  geom_abline(intercept = gamma_00 + u_0i[2], slope = beta_1, color = "orange", size = 1) + # for id = 2
  geom_abline(intercept = gamma_00 + u_0i[3], slope = beta_1, color = "green", size = 1) + # for id = 3
  geom_abline(intercept = gamma_00 + u_0i[4], slope = beta_1, color = "blue", size = 1) + # for id = 4
  geom_abline(intercept = gamma_00 + u_0i[5], slope = beta_1, color = "purple", size = 1) + # for id = 5
  theme_minimal()
```

Let's estimate the effect of $X$ on $Y$ using MLM

Now let's fit the models

```{r}
scenario2.MLM_reml <- lmer(Y ~ 1 + X_cwc + (1 | id), data = scenario2.data, REML = TRUE)
scenario2.MLM_mle <- lmer(Y ~ 1 + X_cwc + (1 | id), data = scenario2.data, REML = FALSE)

# as.numeric(VarCorr(scenario2.MLM.1a_mle)$id[1]) # aligns with specification of sigma_u0
```

Let's now estimate the effect of $X_t$ on $Y_t$ using GEE

```{r}
# displays initial regression estimate of GLM
scenario2.GEE_exch <- gee(Y ~ X_cwc, data = scenario2.data, id = id, family = gaussian(), corstr = "exchangeable")
scenario2.GEE_ind <- gee(Y ~ X_cwc, data = scenario2.data, id = id, family = gaussian(), corstr = "independence")
scenario2.GEE_ar <- gee(Y ~ X_cwc, data = scenario2.data, id = id, family = gaussian(), corstr = "AR-M")
scenario2.GEE_uns <- gee(Y ~ X_cwc, data = scenario2.data, id = id, family = gaussian(), corstr = "unstructured") # with n = 1000, working correlation not positive definite
```

Let's compare the point estimates

```{r}
# Extracting the coefficients
scenario2.coefs <- data.frame(
  row.names = c("Intercept", "X"),
  coef_MLM_reml = fixef(scenario2.MLM_reml),
  coef_MLM_mle = fixef(scenario2.MLM_mle),
  coef_GEE_exch = coef(scenario2.GEE_exch),
  coef_GEE_ind = coef(scenario2.GEE_ind),
  coef_GEE_ar = coef(scenario2.GEE_ar),
  coef_GEE_uns = coef(scenario2.GEE_uns))

# Create nice table
knitr::kable(scenario2.coefs, digits = 3)
```

The point estimates are essentially identical with $n = 1.000$ across all conditions. Note that for the unstructured working correlation matrix, the warning "Working correlation estimate not positive definite" was given.

Nu dat we de within-person centered predictor gebruiken is de interpretatie anders:

-   de gemiddelde angst ($Y$) over alle proefpersonen genomen $\approx 2$, wanneer slaapproblemen ($X$) 0 zijn, waarbij variatie tussen proefpersonen genegeerd wordt. In technische termen, we nemen gelijke waarden aan voor de random effecten.

-   slope beta_1 (within-person interpretatie): *In vergelijking met het persoonlijk gemiddelde van een persoon*, gaat een eenheid toename in slaapproblemen gepaard met een toename van $\approx 0.6$ in angst ($Y$), waarbij variatie tussen proefpersonen genegeerd wordt. In technische termen, we nemen gelijke waarden aan voor de random effecten.

## Scenario 3: SCM met een random intercept, time-varying $X$ en *met* between-person verschillen in $\bar{\mu}_{i}$ (de ene proefpersoon heeft een hogere gemiddelde dan een ander over de tijdspunten) die gerelateerd zijn aan de intercept (van $Y$)

For the third DGM, using the multilevel notation (Raudenbusch and Bryk, 2002), we can specify the within person equation

$$Y_{it} = \beta_{0i} + \beta_1 (X_{it} - \bar{\mu}_{i}) + e_{it} \quad \text{where} \quad e_{it} \sim \mathcal{N}(0, \sigma^2_{e}), \text{iid}$$

and between person equation

$$\beta_{0i} = \gamma_{00} + \gamma_{01} \bar{\mu}_i + u_{0i} \quad \text{where} \quad u_{0i} \sim \mathcal{N}(0, \sigma^2_{u0})$$

in which we predict the within-person mean on the outcome from the within-person mean on the predictor. In other words, by including the between-person slope $\gamma_{01}$ multiplied by the person mean $\bar{\mu}_i$, we could investigate contextual effects.

By plugging the between person equation into the within-person equation we get the combined expression

$$Y_{it} = \gamma_{00} +  \gamma_{01} \bar{\mu}_i + u_{0i} + \beta_1 (X_{it} - \bar{\mu}_{i}) + e_{it}$$

where (1) $\gamma_{00}$ is the overall intercept, (2) $\beta_1$ is the fixed slope and (3) $u_{0i}$ is the random intercept for individual $i$.

Given that we want between person differences in the mean level of $X$ over time, we may simulate $X_{it}$ as such

$$X_{it} = \bar{\mu}_{i} + e_{X, it} \quad \text{where} \quad e_{X, it} \sim \mathcal{N}(0, \sigma^2_{X})$$

where

$$\bar{\mu}_{i} \sim \mathcal{N}(\mu_{\bar{\mu}}, \sigma^2_{\bar{\mu}})$$

Now we may, for instance, give the parameters arbitrary values In addition to the arbitrary values we chose for scenario 2 (note that I define the standard deviations instead of the variances)

-   $\gamma_{00} = 2$
-   $\beta_{1}= 0.6$
-   $\sigma_{u0}= 1$
-   $\sigma_{e}= 0.1$
-   $\sigma_{X}= 1$
-   $\mu_{\bar{\mu}} = 3$
-   $\sigma_{\bar{\mu}} = 1$

we have to define

-   $\gamma_{01} = 0.8$

Let us now simulate data according to data generating model 3

```{r}
# Specify parameters
set.seed(123)  # For reproducibility
n_i <- 1000  # Number of individuals
n_t <- 10  # Number of timepoints
n_obs <- n_i * n_t  # Total number of observations

gamma_00 <- 2
beta_1 <- 0.6 # represents the within-person slope
sigma_u0 <- 1
sigma_e <- 0.1 # this may be unrealistic, but we want to see the effect of the estimation method
sigma_X <- 1
mu_mu_bar <- 3
sigma_mu_bar <- 1

gamma_01 <- 0.8 # represents the between-person slope

# Simulate data
mu_bar_i = rnorm(n_i, mu_mu_bar, sigma_mu_bar)
u_0i = rnorm(n_i, 0, sigma_u0)

# Create a data frame to store the simulated data
scenario3.data <- data.frame()

for (i in 1:n_i) {
  for (t in 1:n_t) {
    
    X_it <- mu_bar_i[i] + rnorm(1, mean = 0, sd = sigma_X)
    
    e_it <- rnorm(1, mean = 0, sd = sigma_e)
    
    Y_it <- gamma_00 + gamma_01 * mu_bar_i[i] + u_0i[i] + beta_1 * (X_it - mu_bar_i[i]) + e_it
    
    # Store the values in the data frame
    scenario3.data <- rbind(scenario3.data, data.frame(id = i, time = t, X = X_it, Y = Y_it, mu_bar = mu_bar_i[i]))
  }
}

head(scenario3.data)
```

first, we have to estimate $\bar{\mu}_i$. One way to do this is by computing the sample mean $\bar{X}_i$ for every individual. Now we can create the centered within clusters variable $X_{it} - \bar{X}_{i}$

```{r}
scenario3.data <- scenario3.data %>%
  group_by(id) %>%
  mutate(X_bar = mean(X)) 

scenario3.data$X_cwc <- scenario3.data$X - scenario2.data$X_bar
scenario3.data$X_cwc_population <- scenario3.data$X - scenario2.data$mu_bar

head(scenario3.data)
```

Let's plot the first 10 individuals with different colors for each participant and separate regression lines for each participant

```{r}
scenario3.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_smooth(method = "lm", se = FALSE, aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) +
  theme_minimal()
```

Let's now do the same but with the true regression lines for each individual

```{r}
head(u_0i, 5)
head(mu_bar_i, 5)
X_bar_i <- unique(scenario3.data$X_bar)

# Population mean of X for each person 
scenario3.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc_population, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) + # overall regression line
  geom_abline(intercept = gamma_00 + gamma_01 * mu_bar_i[1] + u_0i[1], slope = beta_1, color = "red", size = 1) + # for id = 1
  geom_abline(intercept = gamma_00 + gamma_01 * mu_bar_i[2] + u_0i[2], slope = beta_1, color = "orange", size = 1) + # for id = 2
  geom_abline(intercept = gamma_00 + gamma_01 * mu_bar_i[3] + u_0i[3], slope = beta_1, color = "green", size = 1) + # for id = 3
  geom_abline(intercept = gamma_00 + gamma_01 * mu_bar_i[4] + u_0i[4], slope = beta_1, color = "blue", size = 1) + # for id = 4
  geom_abline(intercept = gamma_00 + gamma_01 * mu_bar_i[5] + u_0i[5], slope = beta_1, color = "purple", size = 1) + # for id = 5
  theme_minimal()

# Sample mean of X for each person
scenario3.data %>%
  filter(id <= 5) %>%
  ggplot(aes(x = X_cwc, y = Y, group = id)) +
  geom_point(aes(color = as.factor(id))) +
  geom_abline(intercept = gamma_00, slope = beta_1, color = "black", size = 1) + # overall regression line
  geom_abline(intercept = gamma_00 + gamma_01 * X_bar_i[1] + u_0i[1], slope = beta_1, color = "red", size = 1) + # for id = 1
  geom_abline(intercept = gamma_00 + gamma_01 * X_bar_i[2] + u_0i[2], slope = beta_1, color = "orange", size = 1) + # for id = 2
  geom_abline(intercept = gamma_00 + gamma_01 * X_bar_i[3] + u_0i[3], slope = beta_1, color = "green", size = 1) + # for id = 3
  geom_abline(intercept = gamma_00 + gamma_01 * X_bar_i[4] + u_0i[4], slope = beta_1, color = "blue", size = 1) + # for id = 4
  geom_abline(intercept = gamma_00 + gamma_01 * X_bar_i[5] + u_0i[5], slope = beta_1, color = "purple", size = 1) + # for id = 5
  theme_minimal()
```

Let's estimate the effect of $X$ on $Y$ using MLM

Now let's fit the models

```{r}
scenario3.MLM_reml <- lmer(Y ~ 1 + X_cwc + X_bar + (1 | id), data = scenario3.data, REML = TRUE)
scenario3.MLM_mle <- lmer(Y ~ 1 + X_cwc + X_bar + (1 | id), data = scenario3.data, REML = FALSE)

# summary(scenario3.MLM_reml)
# as.numeric(VarCorr(scenario3.MLM_mle)$id[1]) # aligns with specification of sigma_u0
```

Let's now estimate the effect of $X$ on $Y$ using GEE

```{r}
# displays initial regression estimate of GLM
scenario3.GEE_exch <- gee(Y ~ X_cwc + X_bar, data = scenario3.data, id = id, family = gaussian(), corstr = "exchangeable")
scenario3.GEE_ind <- gee(Y ~ X_cwc + X_bar, data = scenario3.data, id = id, family = gaussian(), corstr = "independence")
scenario3.GEE_ar <- gee(Y ~ X_cwc + X_bar, data = scenario3.data, id = id, family = gaussian(), corstr = "AR-M")
scenario3.GEE_uns <- gee(Y ~ X_cwc + X_bar, data = scenario3.data, id = id, family = gaussian(), corstr = "unstructured") # with n = 1000, working correlation not positive definite
```

Let's compare the point estimates

```{r}
# Extracting the coefficients
scenario3.coefs <- data.frame(
  row.names = c("Intercept", "X", "X_bar"),
  coef_MLM_reml = fixef(scenario3.MLM_reml),
  coef_MLM_mle = fixef(scenario3.MLM_mle),
  coef_GEE_exch = coef(scenario3.GEE_exch),
  coef_GEE_ind = coef(scenario3.GEE_ind),
  coef_GEE_ar = coef(scenario3.GEE_ar),
  coef_GEE_uns = coef(scenario3.GEE_uns))

# Create nice table
knitr::kable(scenario3.coefs, digits = 3)
```

Again, the point estimates are essentially the same across all methods with $n = 1.000$. As a reminder, we specified the overall intercept $\gamma_{00} = 2$, the fixed within-person slope $\beta_1 = 0.6$, and the between person slope $\gamma_{01} = 0.8$. The point estimates are very close to the true values. Although the intercept is consistently off by more than 0.1.

